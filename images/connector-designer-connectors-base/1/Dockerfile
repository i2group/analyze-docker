# syntax=docker/dockerfile:1.3
# i2, i2 Group, the i2 Group logo, and i2group.com are trademarks of N.Harris Computer Corporation.
# Â© N.Harris Computer Corporation (2022-2024)
#
# SPDX short identifier: MIT

# Dynamic labels passed at build time
# revision = CI build number or 'dev' for local builds
ARG revision
# version = image version = name of the directory this Dockerfile is in
ARG version

ARG CONNECTOR_DESIGNER_IMAGE="i2group/i2eng-connector-designer"
ARG NODEJS_VERSION=18
ARG NODEJS_MINIMAL_BASE_IMAGE="i2group/i2eng-analyze-containers-connectors-base-minimal"

# We grab data from the connector-designer image as that's what controls what code
# will be running in this image.
FROM "${CONNECTOR_DESIGNER_IMAGE}:${version}-${revision}" as connector-designer
# ...but this contains both dev and prod dependencies and we only want the prod ones.
RUN cd /opt/app-root/src/connector_template && npm prune --production

# Use a minimal base image
FROM "${NODEJS_MINIMAL_BASE_IMAGE}:${NODEJS_VERSION}-${revision}"

LABEL name="Connector Designer Connector Base" \
  version="${version}" \
  revision="${revision}" \
  maintainer="i2 Group" \
  summary="The base image for Connector Designer connectors." \
  description="The base image for all connectors generated by Connector Designer with runtime dependencies preinstalled." \
  license="MIT"

# Copy the node_modules from the build image
COPY --from=connector-designer --chown=1001 /opt/app-root/src/connector_template/node_modules /opt/app-root/src/node_modules
